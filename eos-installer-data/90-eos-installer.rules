// -*- mode: js; js-indent-level: 4; indent-tabs-mode: nil -*-
// vim: syntax=javascript
//
// DO NOT EDIT THIS FILE, it will be overwritten on update.
//
// Allow the gnome-initial-setup user to do certain actions without
// being interrupted by password dialogs


var isLiveSystem;
try {
    polkit.spawn([
        '/bin/grep', '--quiet', '\\bendless\\.live_boot\\b', '/proc/cmdline'
    ]);
    isLiveSystem = true;
} catch (error) {
    isLiveSystem = false;
}


polkit.addRule(function(action, subject) {
    // This rule should allow the live user any permissions given to the
    // gnome-initial-setup user in 20-gnome-initial-setup.rules, that are needed
    // to run eos-installer. Currently there is only one.

    if (subject.user === 'live' && isLiveSystem &&
        action.id === 'org.freedesktop.udisks2.filesystem-mount-system') {
        if (subject.local)
            return 'yes';
        else
            return 'auth_admin';
    }

    return undefined;
});

polkit.addRule(function(action, subject) {
    // This rule should check only actions that are not already permitted by
    // 20-gnome-initial-setup.rules, and permit them to both the live user and
    // the gnome-initial-setup user.

    if (subject.user !== 'gnome-initial-setup' &&
        !(subject.user === 'live' && isLiveSystem))
        return undefined;

    const allowedUdisksActions = [
        'org.freedesktop.udisks2.filesystem-mount',
        'org.freedesktop.udisks2.open-device',
        'org.freedesktop.udisks2.open-device-system',
    ];

    if (allowedUdisksActions.includes(action.id) ||
        (action.id === 'org.freedesktop.policykit.exec' &&
            action.lookup('program') === '/usr/sbin/eos-repartition-mbr')) {
        if (subject.local)
            return 'yes';
        else
            return 'auth_admin';
    }

    return undefined;
});
